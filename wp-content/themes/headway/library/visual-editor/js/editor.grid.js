/*
 * Headway Grid
 *
 * Copyright 2011-2013, Headway Themes, LLC
 *
 * http://headwaythemes.com
 */
 (function(e,t){e.widget("ui.grid",e.ui.mouse,{options:{columns:null,columnWidth:null,gutterWidth:null,yGridInterval:10,minBlockHeight:40,selectedBlocksContainerClass:"selected-blocks-container",defaultBlockClass:"block",defaultBlockContentClass:"block-content"},_create:function(){grid=this;if(!this.options.columns||!this.options.columnWidth||this.options.gutterWidth===null){return console.error("The grid widget was not supplied all of the required arguments.",this.element,this.options)}this.container=e(this.element).contents().find(this.options.container);this.contents=e(this.element).contents();this.focused=false;this.dragged=false;this.helper=e("<div class='ui-grid-helper block'></div>");this.offset=this.container.offset();this.container.addClass("ui-grid");this.container.disableSelection();this._initResizable(this.container.children("."+this.options.defaultBlockClass.replace(".","")));this._initDraggable(this.container.children("."+this.options.defaultBlockClass.replace(".","")));this._bindDoubleClick();this._bindIFrameMouse()},destroy:function(){this.element.removeClass("ui-grid ui-grid-disabled").removeData("grid").unbind(".grid");this._mouseDestroy();this.contents.unbind("mousedown",this._iFrameMouseDown);this.contents.unbind("mouseup",this._iFrameMouseUp);this.contents.unbind("mousemove",this._iFrameMouseMove);this.element.unbind("mouseleave",this._iFrameMouseUp);e.Widget.prototype.destroy.apply(this,arguments);return this},iframeElement:function(t){return e(this.element).contents().find(t)},resetDraggableResizable:function(){this._initResizable(this.container.children("."+this.options.defaultBlockClass.replace(".","")));this._initDraggable(this.container.children("."+this.options.defaultBlockClass.replace(".","")))},_bindIFrameMouse:function(){this.contents.bind("mousedown",this._iFrameMouseDown);this.contents.bind("mouseup",this._iFrameMouseUp);this.element.bind("mouseleave",this._iFrameMouseUp)},_iFrameMouseDown:function(t){if(t.which!==1)return false;grid=Headway.iframe.data("grid");grid.element.focus();grid.mouseEventDown=t;grid.mouseEventElement=e(grid.mouseEventDown.originalEvent.target);if(typeof grid.bindMouseMove==="undefined"){grid.contents.mousemove(grid._iFrameMouseMove);grid.bindMouseMove=true}if(grid.mouseEventElement.hasClass("ui-resizable-handle")){getBlock(grid.mouseEventElement).data("resizable")._mouseDown(t)}else if(getBlock(grid.mouseEventElement)&&getBlock(grid.mouseEventElement).hasClass(grid.options.defaultBlockClass.replace(".",""))){if(getBlock(grid.mouseEventElement).data("draggable")){getBlock(grid.mouseEventElement).data("draggable")._mouseDown(t)}}else if(grid.element.data("grid")&&(grid.mouseEventElement[0]==grid.container[0]||grid.mouseEventElement[0]==grid.container.parents("div.wrapper")[0])){$i(".blank-block").each(function(){removePanelTab("block-"+getBlockID(e(this)));e(this).remove()});grid.element.data("grid")._mouseDown(t)}},_iFrameMouseMove:function(t){if(typeof grid.mouseEventDown!=="undefined"){if(grid.mouseEventElement.hasClass("ui-resizable-handle")){getBlock(grid.mouseEventElement).data("resizable")._mouseMove(t)}else if(getBlock(grid.mouseEventElement)&&getBlock(grid.mouseEventElement).hasClass(grid.options.defaultBlockClass.replace(".",""))){if(getBlock(grid.mouseEventElement).data("draggable")){getBlock(grid.mouseEventElement).data("draggable")._mouseMove(t)}}else if(grid.element.data("grid")&&(grid.mouseEventElement[0]==grid.container[0]||grid.mouseEventElement[0]==grid.container.parents("div.wrapper")[0])){grid.element.data("grid")._mouseMove(t)}}else if(typeof doingHoverBlockToTop=="undefined"){doingHoverBlockToTop=true;setTimeout(function(){var n=[];var r=t.pageX;var i=t.pageY;$i(".block").each(function(){var t=e(this).offset().left;var s=e(this).offset().top;var o=t+e(this).width();var u=s+e(this).height();if(r<t||r>o)return;if(i<s||i>u)return;n.push(e(this))});n.sort(function(e,t){if(t.width()*t.height()>e.width()*e.height())return 1;return 0});grid.sendBlockToTop(e(n.pop()));delete doingHoverBlockToTop},50)}},_iFrameMouseUp:function(e){if(typeof grid.mouseEventDown!=="undefined"){var t=getBlock(grid.mouseEventElement);var n=grid.element;if(t&&typeof t.data("resizable")!="undefined")t.data("resizable")._mouseUp(e);if(t&&typeof t.data("draggable")!="undefined")t.data("draggable")._mouseUp(e);if(typeof n!="undefined"&&typeof n.data("grid")!="undefined")n.data("grid")._mouseUp(e);delete grid.mouseEventDown}},_mouseStart:function(t){if(!t||grid.container.hasClass("grouping-active"))return;this.mouseStartPosition=[t.pageX-this.container.offset().left,t.pageY-this.container.offset().top];this._trigger("start",t);e(this.container).append(this.helper);this.helper.css({width:this.options.columnWidth,height:0,top:0,left:0,display:"none"});addBlockDimensionsTooltip(this.helper);return true},_mouseDrag:function(t){if(!t||grid.container.hasClass("grouping-active"))return;this.dragged=true;var n=this.mouseStartPosition[0];var r=this.mouseStartPosition[1];var i=t.pageX-e(this.container).offset().left;var s=t.pageY-e(this.container).offset().top;if(n>i){var o=i;i=n;n=o}if(r>s){var o=s;s=r;r=o}var u=e(this.container).offset().left;var a=e(this.container).offset().top;var f=e(this.container).height();var l=e(this.container).width();if(i>=e(this.container).width()&&n>=e(this.container).width())return;if(s>=e(this.container).height()&&r>=e(this.container).height())return;if(n<0)n=0;if(r<0)r=0;if(s>f){s=f}var c=n.toNearest(this.options.columnWidth+this.options.gutterWidth);var h=r.toNearest(this.options.yGridInterval);var p=i.toNearest(this.options.columnWidth+this.options.gutterWidth)-c-this.options.gutterWidth;var d=s.toNearest(this.options.yGridInterval)-r.toNearest(this.options.yGridInterval);Headway.blankBlockOptions={display:"block",left:c,top:h,width:p,height:d};if(c+p>this.options.columns*(this.options.columnWidth+this.options.gutterWidth))Headway.blankBlockOptions.width=l-Headway.blankBlockOptions.left;if(t.pageY>a+f){Headway.blankBlockOptions.height=f-h}this.helper.css(Headway.blankBlockOptions);if(Headway.blankBlockOptions.height<this.options.minBlockHeight){this.helper.addClass("block-error")}else if(this.helper.hasClass("block-error")){this.helper.removeClass("block-error")}this.helper.qtip("option","hide.delay",1e4);this.helper.qtip("show");this.helper.qtip("reposition");this._trigger("drag",t);return false},_mouseStop:function(e){if(!e||grid.container.hasClass("grouping-active"))return;this.dragged=false;this._trigger("stop",e);Headway.blankBlockOptions={width:this.helper.width(),height:this.helper.height(),top:this.helper.position().top,left:this.helper.position().left};this.helper.remove();if(Headway.blankBlockOptions.width<this.options.columnWidth||Headway.blankBlockOptions.height<this.options.minBlockHeight)return false;if(Headway.blankBlockOptions.left+Headway.blankBlockOptions.width>this.options.columns*(this.options.columnWidth+this.options.gutterWidth)+20){var t=Headway.blankBlockOptions.left+Headway.blankBlockOptions.width-(this.options.columns*(this.options.columnWidth+this.options.gutterWidth)-20);Headway.blankBlockOptions.width=Headway.blankBlockOptions.width-t}if(Headway.blankBlockOptions.width<this.options.columnWidth)Headway.blankBlockOptions.width=this.options.columnWidth;this.addBlankBlock(Headway.blankBlockOptions);this.mouseStartPosition=false;return false},_mouseUp:function(t){if(!t||grid.container.hasClass("grouping-active"))return;grid=this;e(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate);if(this._mouseStarted){this._mouseStarted=false;if(t.target==this._mouseDownEvent.target){e.data(t.target,this.widgetName+".preventClickEvent",true)}this._mouseStop(t)}return false},_initResizable:function(t){grid=this;if(typeof t=="string"){t=e(t)}if(typeof t.resizable==="function"){t.resizable("destroy")}t.resizable({handles:"n, e, s, w, ne, se, sw, nw",grid:[this.options.columnWidth+this.options.gutterWidth,this.options.yGridInterval],containment:this.container,minHeight:this.options.minBlockHeight,maxWidth:this.options.columns*(this.options.columnWidth+this.options.gutterWidth),start:this._resizableStart,resize:this._resizableResize,stop:this._resizableStop})},_resizableStart:function(e,t){var n=getBlock(t.element);var r=parseInt(n.css("minHeight").replace("px",""));var i=n.height();if(r<=i){n.css("minHeight",0)}n.addClass("block-hover");n.qtip("option","hide.delay",1e4);n.qtip("show");n.qtip("reposition")},_resizableResize:function(e,t){var n=getBlock(t.element);n.qtip("show");n.qtip("reposition")},_resizableStop:function(e,t){var n=getBlock(t.element);var r=Math.ceil(n.width()/(grid.options.columnWidth+grid.options.gutterWidth));var i=Math.ceil(n.position().left/(grid.options.columnWidth+grid.options.gutterWidth));var s=getBlockDimensionsPixels(n).height;var o=getBlockGridWidth(n);var u=getBlockGridLeft(n);var a=t.originalSize.height;var f=function(){n.css("width","");n.css("left","");updateBlockDimensionsHidden(getBlockID(n),getBlockDimensions(n));updateBlockPositionHidden(getBlockID(n),getBlockPosition(n));blockIntersectCheck(n)?allowSaving():disallowSaving();n.qtip("option","hide.delay",25);n.qtip("show");n.qtip("reposition");n.removeClass("block-hover")};logHistory({description:"Resized block #"+getBlockID(n),action:function(){n.removeClass("grid-width-"+o);n.addClass("grid-width-"+r);n.removeClass("grid-left-"+u);n.addClass("grid-left-"+i);n.height(s);n.attr({"data-grid-left":i,"data-grid-top":getBlockPositionPixels(n).top,"data-width":r,"data-height":s});f()},actionReverse:function(){n.removeClass("grid-width-"+r);n.addClass("grid-width-"+o);n.removeClass("grid-left-"+i);n.addClass("grid-left-"+u);n.height(a);n.attr({"data-grid-left":u,"data-grid-top":t.originalPosition.top,"data-width":o,"data-height":a});f()}})},_initDraggable:function(t){if(typeof t=="string"){t=e(t)}if(typeof t.draggable==="function"){t.draggable("destroy")}grid=this;t.css("cursor","move").draggable({grid:[this.options.columnWidth+this.options.gutterWidth,this.options.yGridInterval],containment:this.iframeElement(this.options.container),scrollSpeed:40,start:this._draggableStart,stop:this._draggableStop,drag:this._draggableDrag})},_draggableStart:function(t,n){if(e(t.originalEvent.target).parents(".block-controls").length===1||e(t.originalEvent.target).parents(".block-info").length===1){e(this).draggable("stop");return false}e(this).data("dragging",true);blockGroupingOriginals={};blockGroupingOriginals[getBlockID(this)]={top:getBlockPositionPixels(this).top,left:getBlockPositionPixels(this).left};if(e(this).hasClass("grouped-block")){grid.container.find(".grouped-block").each(function(n){if(t.srcElement==this)return;blockGroupingOriginals[getBlockID(this)]={top:parseInt(e(this).css("top").replace("px",""))||0,left:parseInt(e(this).css("left").replace("px",""))||0}});grid.sendBlockToTop(grid.container.find(".grouped-block"))}else{grid.container.removeClass("grouping-active");grid.container.find(".grouped-block").removeClass("grouped-block");hideTaskNotification()}beginTop=e(this).offset().top;beginLeft=e(this).offset().left;e(getBlock(n.helper)).qtip("hide")},_draggableDrag:function(t,n){e(getBlock(n.helper)).qtip("hide");if(e(this).hasClass("grouped-block")){var r=e(this).offset().top-beginTop;var i=e(this).offset().left-beginLeft;var s=[];grid.container.find(".grouped-block").each(function(n){if(t.srcElement==this)return;s.push({block:e(this),top:blockGroupingOriginals[getBlockID(this)].top+r,left:blockGroupingOriginals[getBlockID(this)].left+i})});var o=true;var u=true;var a=0;var f=0;var l=0;e.each(s,function(e,t){if(blockGroupingOriginals[getBlockID(t.block)].top+r<0){o=false;a=Math.abs(blockGroupingOriginals[getBlockID(t.block)].top+r)}if(blockGroupingOriginals[getBlockID(t.block)].left+i<0){u=false;f=Math.abs(blockGroupingOriginals[getBlockID(t.block)].left+i)}if(t.block.width()+blockGroupingOriginals[getBlockID(t.block)].left+i>$i(".grid-container").width()){u=false;f=-(blockGroupingOriginals[getBlockID(t.block)].left+i)}});e.each(s,function(e,t){if(o)t.block.css("top",t.top);if(u)t.block.css("left",t.left)});if(!o||!u){e(this).data("draggableOverflow",{top:a,left:f})}else{e(this).removeData("draggableOverflow")}}else{grid.container.find(".grouped-block").removeClass("grouped-block")}},_draggableStop:function(t,n){e(this).data("dragging",false);if(grid.container.find(".grouped-block").length){var r=grid.container.find(".grouped-block")}else{var r=getBlock(n.helper)}var i=[];if(r.length===1){var s="Moved block #"+getBlockID(block)}else{var s="Mass Moved Blocks: "}r.each(function(){var t=0;var n=0;if(typeof e(this).data("draggableOverflow")!="undefined"){var t=e(this).data("draggableOverflow").left;var n=e(this).data("draggableOverflow").top;e(this).removeData("draggableOverflow")}i.push({block:e(this),newGridLeft:Math.ceil((e(this).position().left+t)/(grid.options.columnWidth+grid.options.gutterWidth)),oldGridLeft:getBlockGridLeft(e(this)),newGridTop:(getBlockPositionPixels(e(this)).top+n).toNearest(10),oldGridTop:blockGroupingOriginals[getBlockID(this)].top.toNearest(10)});if(r.length>1)s+="#"+getBlockID(this)+", "});if(r.length>1)s=s.substring(0,s.length-2);var o=function(e,t){var n=e.block;var r=e.oldGridLeft;var i=e.oldGridTop;var s=e.newGridLeft;var o=e.newGridTop;if(t){r=e.newGridLeft;i=e.newGridTop;s=e.oldGridLeft;o=e.oldGridTop}n.removeClass("grid-left-"+r);n.addClass("grid-left-"+s);n.css("top",o);n.css("left","");n.attr({"data-grid-left":s,"data-grid-top":o});updateBlockPositionHidden(getBlockID(n),getBlockPosition(n));if(blockIntersectCheck(n)){allowSaving()}else{disallowSaving()}};logHistory({description:s,action:function(){jQuery.each(i,function(e,t){o(t,false)})},actionReverse:function(){jQuery.each(i,function(e,t){o(t,true)})}});e(document).focus();e(this).data("hoverWaitTimeout",setTimeout(function(){e(getBlock(n.helper)).qtip("reposition");e(getBlock(n.helper)).qtip("show")},300))},_bindDoubleClick:function(){grid=this;this.container.delegate("."+this.options.defaultBlockClass.replace(".",""),"dblclick",function(t){if(e(t.target).parents(".block-info").length==1||e(t.target).parents(".block-controls").length==1)return false;if(e(this).hasClass("grouped-block")&&grid.container.find(".grouped-block").length===1){e(this).removeClass("grouped-block");grid.container.removeClass("grouping-active");hideTaskNotification()}else if(e(this).hasClass("grouped-block")){e(this).removeClass("grouped-block")}else{e(this).addClass("grouped-block");grid.container.addClass("grouping-active");showTaskNotification("Mass Block Selection Mode",function(){$i(".grouped-block").removeClass("grouped-block");Headway.iframe.data("grid").container.removeClass("grouping-active")})}})},addBlankBlock:function(t,n,r){var i={top:0,left:0,width:140,height:this.options.minBlockHeight,id:null};var t=e.extend({},i,t);if(typeof n=="undefined")var n=true;if(typeof r=="undefined")var r=false;var s=t.id==false||t.id==null?getAvailableBlockID():t.id;if(typeof s==="undefined"||!s)return false;Headway.blankBlock=e('<div><div class="block-content-fade block-content"></div><h3 class="block-type" style="display: none;"><span></span></h3></div>').attr("data-id",s).data("id",s).attr("id","block-"+s).addClass(this.options.defaultBlockClass.replace(".",""));var o="This is the ID for the block.  The ID of the block is displayed in the WordPress admin panel if it is a widget area or navigation block.  Also, this can be used with advanced developer functions.";var u="Click to change the block type.";var a="Show the options for this block.";var f="Delete this block.";Headway.blankBlock.addClass("blank-block");Headway.blankBlock.append('			<div class="block-info">				<span class="id tooltip" title="'+o+'">'+s+'</span>				<span class="type type-unknown tooltip" title="'+u+'">Unknown</span>			</div>');Headway.blankBlock.append('			<div class="block-controls">				<span class="options tooltip" title="'+a+'">Options</span>				<span class="delete tooltip" title="'+f+'">Delete</span>			</div>');var l=Headway.blankBlock;l.css({width:parseInt(t.width),height:parseInt(t.height),top:parseInt(t.top),left:parseInt(t.left),position:"absolute",visibility:"hidden"});l.appendTo(this.container);if(n){var c=String(l.width()).replace("px","");var h=Math.ceil(c/(grid.options.columnWidth+grid.options.gutterWidth));var p=String(l.position().left).replace("px","");var d=Math.ceil(p/(grid.options.columnWidth+grid.options.gutterWidth))}else{h=parseInt(t.width);d=parseInt(t.left)}l.attr({"data-width":h,"data-height":parseInt(t.height),"data-grid-top":parseInt(t.top),"data-grid-left":d});l.css("width","").addClass("grid-width-"+h);l.css("left","").addClass("grid-left-"+d);l.css("visibility","visible");this._initResizable(l);this._initDraggable(l);blockIntersectCheck(l);if(r==false){setupTooltips("iframe");openBlockTypeSelector(e(Headway.blankBlock))}return l},setupBlankBlock:function(e,t){if(typeof t=="undefined")var t=false;var n=getBlockTypeIcon(e,true);Headway.blankBlock.removeClass("blank-block");Headway.blankBlock.addClass("block-type-"+e);Headway.blankBlock.find(".block-info span.type").attr("class","").addClass("type").addClass("type-"+e).html(getBlockTypeNice(e)).css("backgroundImage","url("+n+")");loadBlockContent({blockElement:Headway.blankBlock,blockOrigin:{type:e,id:0,layout:Headway.currentLayout},blockSettings:{dimensions:getBlockDimensions(Headway.blankBlock),position:getBlockPosition(Headway.blankBlock)}});if(getBlockTypeObject(e)["fixed-height"]===true){Headway.blankBlock.addClass("block-fixed-height")}else{Headway.blankBlock.addClass("block-fluid-height")}if(!getBlockTypeObject(e)["show-content-in-grid"])Headway.blankBlock.addClass("hide-content-in-grid");Headway.blankBlock.find("h3.block-type span").text(getBlockTypeNice(e));Headway.blankBlock.find("h3.block-type").show();addNewBlockHidden(getBlockID(Headway.blankBlock),getBlockType(Headway.blankBlock));updateBlockPositionHidden(getBlockID(Headway.blankBlock),getBlockPosition(Headway.blankBlock));updateBlockDimensionsHidden(getBlockID(Headway.blankBlock),getBlockDimensions(Headway.blankBlock));if(blockIntersectCheck(Headway.blankBlock)){allowSaving()}else{disallowSaving()}var r=Headway.blankBlock;delete Headway.blankBlock;delete Headway.blankBlockOptions;if(t==false){setupTooltips("iframe")}return r},addBlock:function(t){var n={top:0,left:0,width:1,height:this.options.minBlockHeight,type:null,id:null,settings:[]};var t=e.extend({},n,t);if(this.addBlankBlock(t,false,true)){var r=this.setupBlankBlock(t.type,true);var i=getBlockID(r);e.each(t.settings,function(e,t){updatePanelInputHidden({id:e,value:t,group:"general",isBlock:"true",blockID:i});if(e=="mirror-block"){updateBlockMirrorStatus(false,r,t,false)}})}else{return false}},sendBlockToTop:function(e){if(typeof e=="string")var e=getBlock(e);if(!e||!e.length)return;$i(".block").css("zIndex",1);e.css("zIndex",2)}});e.extend(e.ui.grid,{version:"0.7"})})(jQuery)